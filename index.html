<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault - Mobility v23</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .reading-typography { font-family: 'Georgia', serif; line-height: 1.8; }
        .active-glow { border: 2px solid #6366f1 !important; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2); }
        .tag-active { background-color: #6366f1 !important; color: white !important; border-color: #6366f1 !important; }
        mark { background-color: #fef08a; color: #1e293b; padding: 0 2px; border-radius: 2px; }
        .dark mark { background-color: #854d0e; color: #fefce8; }
        
        /* Hide scrollbars for the tag ribbon */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media print { .no-print { display: none !important; } main { padding: 0 !important; max-width: 100% !important; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300 overflow-hidden h-screen w-screen">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            const STORAGE_KEY = 'vault_v23_master';
            const [notes, setNotes] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            });
            
            const [buffer, setBuffer] = useState({ title: '', content: '', tags: '' });
            const [editingId, setEditingId] = useState(null);
            const [readMode, setReadMode] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('vault_theme') === 'dark');
            const [query, setQuery] = useState('');
            const [tagFilter, setTagFilter] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [showBackToTop, setShowBackToTop] = useState(false);
            const textareaRef = useRef(null);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('vault_theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('vault_theme', 'light');
                }
            }, [darkMode]);

            const handleScroll = (e) => {
                setShowBackToTop(e.target.scrollTop > 300);
            };

            const scrollToTop = () => {
                scrollRef.current?.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleImport = (e) => {
                const fileReader = new FileReader();
                const file = e.target.files[0];
                if (!file) return;
                fileReader.readAsText(file, "UTF-8");
                fileReader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Array.isArray(importedData)) {
                            const combined = [...importedData, ...notes];
                            const uniqueMap = new Map();
                            combined.forEach(item => { if(!uniqueMap.has(item.id)) uniqueMap.set(item.id, item); });
                            const finalLibrary = Array.from(uniqueMap.values()).sort((a, b) => b.id - a.id);
                            setNotes(finalLibrary);
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(finalLibrary));
                        }
                    } catch (err) { alert("Invalid JSON."); }
                };
            };

            const handlePaste = async (e) => {
                const pastedText = e.clipboardData.getData('text');
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const match = pastedText.match(urlRegex);
                if (match) {
                    setIsAnalyzing(true);
                    try {
                        const response = await fetch(`https://api.microlink.io?url=${encodeURIComponent(match[0])}`);
                        const data = await response.json();
                        if (data.status === 'success') {
                            const meta = data.data;
                            setBuffer(prev => {
                                const domain = new URL(match[0]).hostname.replace('www.', '').split('.')[0];
                                const existingTags = prev.tags.split(',').map(t => t.trim()).filter(t => t);
                                if (!existingTags.includes(domain)) existingTags.push(domain);
                                return {
                                    ...prev,
                                    title: prev.title.trim() === '' ? meta.title : prev.title,
                                    tags: existingTags.join(', ')
                                };
                            });
                        }
                    } catch (err) { console.error(err); } finally { setIsAnalyzing(false); }
                }
            };

            const onSave = () => {
                if (!buffer.title.trim() && !buffer.content.trim()) return;
                const ts = new Date().toLocaleString();
                const updated = editingId 
                    ? notes.map(n => n.id === editingId ? { ...buffer, id: editingId, timestamp: `Edited ${ts}` } : n)
                    : [{ ...buffer, id: Date.now(), timestamp: ts }, ...notes];
                setNotes(updated);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
            };

            const onNew = () => {
                if (buffer.title.trim() || buffer.content.trim()) onSave();
                setBuffer({ title: '', content: '', tags: '' });
                setEditingId(null);
                setReadMode(false);
                scrollToTop();
                setTimeout(() => textareaRef.current?.focus(), 100);
            };

            const loadToEditor = (note) => {
                setEditingId(note.id);
                setBuffer({ title: note.title, content: note.content, tags: note.tags || '' });
                setReadMode(false);
                scrollToTop();
                setTimeout(() => {
                    if(textareaRef.current) {
                        textareaRef.current.focus();
                        const len = textareaRef.current.value.length;
                        textareaRef.current.setSelectionRange(len, len);
                    }
                }, 100);
            };

            const applyFormatting = (prefix, suffix) => {
                const el = textareaRef.current;
                const start = el.selectionStart;
                const end = el.selectionEnd;
                const newText = el.value.substring(0, start) + prefix + el.value.substring(start, end) + suffix + el.value.substring(end);
                setBuffer({ ...buffer, content: newText });
                setTimeout(() => { el.focus(); el.setSelectionRange(start + prefix.length, end + prefix.length); }, 10);
            };

            const displayedNotes = useMemo(() => notes.filter(n => (n.title+n.content+(n.tags||'')).toLowerCase().includes(query.toLowerCase()) && (tagFilter ? n.tags?.toLowerCase().includes(tagFilter) : true)), [notes, query, tagFilter]);

            const uniqueTags = useMemo(() => {
                const tags = new Set();
                notes.forEach(n => n.tags?.split(',').forEach(t => t.trim() && tags.add(t.trim().toLowerCase())));
                return Array.from(tags).sort();
            }, [notes]);

            const TagRibbon = () => (
                <div className="flex overflow-x-auto no-scrollbar gap-2 py-2 mb-4">
                    <button onClick={() => setTagFilter('')} className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase border whitespace-nowrap transition-all ${!tagFilter ? 'tag-active text-white' : 'bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400'}`}>All</button>
                    {uniqueTags.map(tag => (
                        <button key={tag} onClick={() => setTagFilter(tag === tagFilter ? '' : tag)} className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase border whitespace-nowrap transition-all ${tagFilter === tag ? 'tag-active text-white' : 'bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400'}`}>#{tag}</button>
                    ))}
                </div>
            );

            return (
                <div className="h-full flex flex-col md:flex-row dark:bg-slate-900 font-sans">
                    
                    {/* DESKTOP SIDEBAR */}
                    <aside className="hidden md:flex w-72 bg-white dark:bg-slate-800 border-r dark:border-slate-700 p-6 flex-col no-print">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="font-black text-xl dark:text-white italic tracking-tighter">VAULT v23</h1>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg">{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                        </div>
                        <div className="flex-1 overflow-y-auto pr-2">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Filters</h3>
                            <TagRibbon />
                            <div className="space-y-4 pt-6 border-t dark:border-slate-700 mt-4">
                                <button onClick={() => setReadMode(!readMode)} className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">{readMode ? 'üìë Editor' : 'üìñ Reader'}</button>
                                <button onClick={() => {const d=JSON.stringify(notes); const u='data:application/json;charset=utf-8,'+encodeURIComponent(d); const l=document.createElement('a'); l.setAttribute('href', u); l.setAttribute('download', 'vault.json'); l.click();}} className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">üì§ Export</button>
                                <label className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase cursor-pointer block">üì• Import <input type="file" className="hidden" onChange={handleImport} /></label>
                                <button onClick={() => window.print()} className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">üñ®Ô∏è Print</button>
                            </div>
                        </div>
                    </aside>

                    {/* MAIN CONTENT */}
                    <main ref={scrollRef} onScroll={handleScroll} className="flex-1 overflow-y-auto p-4 md:p-12 pb-32 md:pb-12 h-full relative">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-center md:hidden mb-4 no-print">
                                <h1 className="font-black text-xl dark:text-white italic tracking-tighter">VAULT</h1>
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-lg">{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                            </div>

                            <div className="mb-4 no-print">
                                <input type="text" placeholder="Search insights..." className="w-full bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border-2 border-transparent focus:border-indigo-500 outline-none dark:text-white dark:placeholder-slate-600" value={query} onChange={(e) => setQuery(e.target.value)} />
                            </div>

                            {/* MOBILE TAG RIBBON */}
                            <div className="md:hidden no-print">
                                <TagRibbon />
                            </div>

                            {!readMode && (
                                <section className={`bg-white dark:bg-slate-800 p-6 md:p-8 rounded-3xl border-2 mb-16 no-print transition-all ${editingId ? 'active-glow border-indigo-500' : 'border-transparent dark:border-slate-700'}`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <div className="flex flex-col">
                                            <span className="text-[10px] font-black uppercase text-indigo-500 tracking-widest">{editingId ? 'Editing' : 'New Draft'}</span>
                                            {isAnalyzing && <span className="text-[9px] dark:text-slate-400 animate-pulse uppercase font-black">Analysing...</span>}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => applyFormatting('**', '**')} className="px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-black dark:text-white">B</button>
                                            <button onClick={() => applyFormatting('<mark>', '</mark>')} className="px-3 py-2 bg-yellow-100 rounded-lg text-xs font-black text-yellow-800">H</button>
                                            <button onClick={onNew} className="px-4 py-2 bg-slate-800 dark:bg-indigo-900 text-white rounded-lg font-bold">‚äï</button>
                                            <button onClick={onSave} className="px-6 py-2 bg-indigo-600 text-white rounded-lg text-xs font-black uppercase shadow-lg">Save</button>
                                        </div>
                                    </div>
                                    <input className="w-full bg-transparent text-3xl md:text-4xl font-black dark:text-white outline-none mb-4 placeholder-slate-200" placeholder="Title" value={buffer.title} onChange={e => setBuffer({...buffer, title: e.target.value})} />
                                    <input className="w-full bg-transparent text-sm font-bold text-indigo-400 italic outline-none mb-4" placeholder="tags" value={buffer.tags} onChange={e => setBuffer({...buffer, tags: e.target.value})} />
                                    <textarea ref={textareaRef} onPaste={handlePaste} className="w-full h-64 md:h-80 bg-transparent dark:text-slate-200 text-lg outline-none resize-none pt-4 border-t dark:border-slate-700" placeholder="Start typing..." value={buffer.content} onChange={e => setBuffer({...buffer, content: e.target.value})} />
                                </section>
                            )}

                            <div className="space-y-12 pb-20">
                                {displayedNotes.map(n => (
                                    <article key={n.id} onClick={() => loadToEditor(n)} className={`cursor-pointer border-l-4 pl-6 md:pl-10 transition-all ${editingId === n.id ? 'border-indigo-500' : 'border-slate-200 dark:border-slate-700 hover:border-indigo-300'}`}>
                                        <div className="flex gap-2 mb-2 no-print">
                                            {n.tags?.split(',').map(t => t.trim() && <span key={t} className="text-[9px] font-black text-indigo-500 uppercase bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded">#{t}</span>)}
                                        </div>
                                        <h2 className={`font-black dark:text-white mb-4 ${readMode ? 'text-4xl reading-typography' : 'text-2xl'}`}>{n.title || 'Untitled'}</h2>
                                        <div className={`prose dark:prose-invert max-w-none text-slate-600 dark:text-slate-300 ${readMode ? 'text-xl reading-typography' : 'text-base'}`} dangerouslySetInnerHTML={{ __html: marked.parse(n.content || '') }} />
                                        <div className="mt-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">{n.timestamp}</div>
                                    </article>
                                ))}
                            </div>
                        </div>

                        {showBackToTop && (
                            <button onClick={scrollToTop} className="md:hidden fixed bottom-24 right-6 z-50 p-4 bg-indigo-600 text-white rounded-full shadow-2xl transition-all active:scale-90">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                            </button>
                        )}
                    </main>

                    {/* MOBILE DOCK */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 no-print flex w-full overflow-x-auto no-scrollbar gap-2 p-3 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-t dark:border-slate-700">
                        <button onClick={() => setReadMode(!readMode)} className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">{readMode ? 'üìë Editor' : 'üìñ Reader'}</button>
                        <button onClick={() => {const d=JSON.stringify(notes); const u='data:application/json;charset=utf-8,'+encodeURIComponent(d); const l=document.createElement('a'); l.setAttribute('href', u); l.setAttribute('download', 'vault.json'); l.click();}} className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">üì§ Export</button>
                        <label className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase cursor-pointer">üì• Import <input type="file" className="hidden" onChange={handleImport} /></label>
                        <button onClick={() => window.print()} className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">üñ®Ô∏è Print</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>