<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault - Unified v29.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .reading-typography { font-family: 'Georgia', serif; line-height: 1.8; }
        .active-glow { border: 2px solid #6366f1 !important; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2); }
        .tag-active { background-color: #6366f1 !important; color: white !important; border-color: #6366f1 !important; }
        mark { background-color: #fef08a; color: #1e293b; padding: 0 2px; border-radius: 2px; }
        .dark mark { background-color: #854d0e; color: #fefce8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .ruled-bg { background-image: linear-gradient(#e2e8f0 1px, transparent 1px); background-size: 100% 2rem; line-height: 2rem !important; }
        .dark .ruled-bg { background-image: linear-gradient(#334155 1px, transparent 1px); }
        article img { max-width: 100%; height: auto; border-radius: 1rem; cursor: zoom-in; margin: 1.5rem 0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade { animation: fadeIn 0.2s ease-out; }
        @media print { .no-print { display: none !important; } main { padding: 0 !important; max-width: 100% !important; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300 overflow-hidden h-screen w-screen">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const VAULT_KEY = 'vault_master_v29';

        const App = () => {
            const [notes, setNotes] = useState(() => {
                const saved = localStorage.getItem(VAULT_KEY);
                try { return saved ? JSON.parse(saved) : []; } catch (e) { return []; }
            });
            
            const [buffer, setBuffer] = useState({ title: '', content: '', tags: '' });
            const [editingId, setEditingId] = useState(null);
            const [readMode, setReadMode] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('vault_theme') === 'dark');
            const [query, setQuery] = useState('');
            const [tagFilter, setTagFilter] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [showBackToTop, setShowBackToTop] = useState(false);
            const [zoomImg, setZoomImg] = useState(null);
            
            const textareaRef = useRef(null);
            const scrollRef = useRef(null);

            useEffect(() => { localStorage.setItem(VAULT_KEY, JSON.stringify(notes)); }, [notes]);

            useEffect(() => {
                const handleBeforeUnload = () => {
                    localStorage.setItem(VAULT_KEY, JSON.stringify(notes));
                    if (notes.length > 0) {
                        const now = new Date();
                        const pad = (n) => n.toString().padStart(2, '0');
                        const ts = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
                        const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `vault_backup_${ts}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [notes]);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                localStorage.setItem('vault_theme', darkMode ? 'dark' : 'light');
            }, [darkMode]);

            const loadToEditor = (note) => {
                setReadMode(false);
                setEditingId(note.id);
                setBuffer({ title: note.title || '', content: note.content || '', tags: note.tags || '' });
                scrollRef.current?.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => textareaRef.current?.focus(), 300);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const markdownImg = `\n![image](${event.target.result})\n`;
                    setBuffer(prev => ({ ...prev, content: prev.content + markdownImg }));
                };
                reader.readAsDataURL(file);
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fr = new FileReader();
                fr.onload = (ex) => {
                    try {
                        const data = JSON.parse(ex.target.result);
                        setNotes(data);
                    } catch (err) { alert("Invalid File Format"); }
                };
                fr.readAsText(file);
            };

            const handlePaste = async (e) => {
                const pastedText = e.clipboardData.getData('text');
                const match = pastedText.match(/(https?:\/\/[^\s]+)/g);
                if (match && !pastedText.startsWith('data:image')) {
                    setIsAnalyzing(true);
                    try {
                        const res = await fetch(`https://api.microlink.io?url=${encodeURIComponent(match[0])}`);
                        const data = await res.json();
                        if (data.status === 'success') {
                            setBuffer(prev => ({ ...prev, title: prev.title || data.data.title }));
                        }
                    } catch (err) {} finally { setIsAnalyzing(false); }
                }
            };

            const onSave = () => {
                if (!buffer.title.trim() && !buffer.content.trim()) return;
                const ts = new Date().toLocaleString();
                if (editingId) {
                    setNotes(notes.map(n => n.id === editingId ? { ...buffer, id: editingId, timestamp: `Edited ${ts}` } : n));
                } else {
                    const newNote = { ...buffer, id: Date.now(), timestamp: ts };
                    setNotes([newNote, ...notes]);
                    setEditingId(newNote.id);
                }
            };

            const onNew = () => {
                if (buffer.title.trim() || buffer.content.trim()) onSave();
                setBuffer({ title: '', content: '', tags: '' });
                setEditingId(null);
                setReadMode(false);
                scrollRef.current?.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => textareaRef.current?.focus(), 100);
            };

            const applyFormatting = (p, s) => {
                const el = textareaRef.current;
                const start = el.selectionStart;
                const end = el.selectionEnd;
                const val = buffer.content;
                const newVal = val.substring(0, start) + p + val.substring(start, end) + s + val.substring(end);
                setBuffer({ ...buffer, content: newVal });
            };

            const filteredNotes = useMemo(() => notes.filter(n => 
                (n.title+n.content+(n.tags||'')).toLowerCase().includes(query.toLowerCase()) && 
                (!tagFilter || n.tags?.toLowerCase().includes(tagFilter))
            ), [notes, query, tagFilter]);

            const uniqueTags = useMemo(() => {
                const tags = new Set();
                notes.forEach(n => n.tags?.split(',').forEach(t => t.trim() && tags.add(t.trim().toLowerCase())));
                return Array.from(tags).sort();
            }, [notes]);

            useEffect(() => {
                const handleClick = (e) => { if (e.target.tagName === 'IMG' && !zoomImg) setZoomImg(e.target.src); };
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, [zoomImg]);

            return (
                <div className="h-full flex flex-col md:flex-row dark:bg-slate-900 font-sans">
                    {zoomImg && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-white/80 dark:bg-slate-900/90 backdrop-blur-2xl p-4 animate-fade no-print" onClick={() => setZoomImg(null)}>
                            <button className="absolute top-6 right-6 w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-xl">√ó</button>
                            <img src={zoomImg} className="max-w-full max-h-full rounded-2xl shadow-2xl cursor-zoom-out object-contain" />
                        </div>
                    )}

                    <aside className="hidden md:flex w-72 bg-white dark:bg-slate-800 border-r dark:border-slate-700 p-6 flex-col no-print">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="font-black text-xl dark:text-white italic uppercase tracking-tighter">Vault v29.1</h1>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg">{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar">
                            <div className="flex overflow-x-auto no-scrollbar gap-2 py-2 mb-4">
                                <button onClick={() => setTagFilter('')} className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase border whitespace-nowrap ${!tagFilter ? 'tag-active shadow-md' : 'bg-white dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'}`}>All</button>
                                {uniqueTags.map(tag => (
                                    <button key={tag} onClick={() => setTagFilter(tag)} className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase border whitespace-nowrap ${tagFilter === tag ? 'tag-active shadow-md' : 'bg-white dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'}`}>#{tag}</button>
                                ))}
                            </div>
                            <div className="space-y-4 pt-6 border-t dark:border-slate-700 mt-4">
                                <button onClick={() => setReadMode(!readMode)} className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">{readMode ? 'Back to Editor' : 'Reader Mode'}</button>
                                <button onClick={() => {
                                    const l=document.createElement('a'); l.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(notes)); l.download='vault_export.json'; l.click();
                                }} className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase">Export</button>
                                <label className="w-full text-left p-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 dark:text-slate-300 uppercase cursor-pointer block">Import <input type="file" className="hidden" onChange={handleImport} /></label>
                            </div>
                        </div>
                    </aside>

                    <main ref={scrollRef} onScroll={(e) => setShowBackToTop(e.target.scrollTop > 300)} className="flex-1 overflow-y-auto p-4 md:p-12 pb-32 h-full relative">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-center md:hidden mb-4 no-print">
                                <h1 className="font-black text-xl dark:text-white italic uppercase tracking-tighter">Vault</h1>
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm">{darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                            </div>

                            <input type="text" placeholder="Search insights..." className="w-full bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border-2 border-transparent focus:border-indigo-500 outline-none dark:text-white mb-4 no-print" value={query} onChange={(e) => setQuery(e.target.value)} />

                            {!readMode && (
                                <section className={`bg-white dark:bg-slate-800 p-6 md:p-8 rounded-3xl border-2 mb-16 no-print transition-all ${editingId ? 'active-glow border-indigo-500' : 'border-transparent dark:border-slate-700'}`}>
                                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                                        <div className="flex flex-col">
                                            <span className="text-[10px] font-black uppercase text-indigo-500 tracking-widest">{editingId ? 'Editing Insight' : 'New Thought'}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => applyFormatting('**', '**')} className="px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-black dark:text-white">B</button>
                                            <label className="px-3 py-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-black dark:text-white cursor-pointer transition-all hover:bg-indigo-600 hover:text-white">
                                                üì∑ <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                            </label>
                                            <button onClick={onNew} className="px-4 py-2 bg-slate-800 dark:bg-indigo-900 text-white rounded-lg font-bold">‚äï</button>
                                            <button onClick={onSave} className="px-6 py-2 bg-indigo-600 text-white rounded-lg text-xs font-black uppercase shadow-lg">Save</button>
                                        </div>
                                    </div>
                                    <input className="w-full bg-transparent text-3xl font-black dark:text-white outline-none mb-4" placeholder="Title" value={buffer.title} onChange={e => setBuffer({...buffer, title: e.target.value})} />
                                    <input className="w-full bg-transparent text-sm font-bold text-indigo-400 italic outline-none mb-4" placeholder="tags (separated by commas)" value={buffer.tags} onChange={e => setBuffer({...buffer, tags: e.target.value})} />
                                    <textarea ref={textareaRef} onPaste={handlePaste} className="ruled-bg w-full h-80 bg-transparent dark:text-slate-200 text-lg outline-none resize-none pt-4 border-t dark:border-slate-700" placeholder="Type or paste link..." value={buffer.content} onChange={e => setBuffer({...buffer, content: e.target.value})} />
                                </section>
                            )}

                            <div className="space-y-12 pb-20">
                                {filteredNotes.map(n => (
                                    <article key={n.id} onClick={() => loadToEditor(n)} className={`cursor-pointer border-l-4 pl-6 transition-all group ${editingId === n.id ? 'border-indigo-500 bg-indigo-50/30 dark:bg-indigo-900/10' : 'border-slate-200 dark:border-slate-700 hover:border-indigo-300'}`}>
                                        <div className="flex gap-2 mb-2">
                                            {n.tags?.split(',').map(t => t.trim() && <span key={t} className="text-[9px] font-black text-indigo-500 uppercase bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded">#{t}</span>)}
                                        </div>
                                        <h2 className={`font-black dark:text-white mb-2 ${readMode ? 'text-4xl reading-typography' : 'text-2xl group-hover:text-indigo-500'}`}>{n.title || 'Untitled'}</h2>
                                        <div className={`prose dark:prose-invert max-w-none text-slate-600 dark:text-slate-300 ${readMode ? 'text-xl reading-typography' : 'text-base'}`} dangerouslySetInnerHTML={{ __html: marked.parse(n.content || '') }} />
                                        <div className="mt-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">{n.timestamp}</div>
                                    </article>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* MOBILE NAV - NOW INCLUDES IMPORT */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 no-print flex overflow-x-auto no-scrollbar gap-2 p-3 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-t dark:border-slate-700">
                        <button onClick={() => setReadMode(!readMode)} className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 uppercase">{readMode ? 'Editor' : 'Reader'}</button>
                        <button onClick={onNew} className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-indigo-600 text-white uppercase">New</button>
                        <button onClick={() => {
                            const l=document.createElement('a'); l.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(notes)); l.download='vault_export.json'; l.click();
                        }} className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 uppercase">Export</button>
                        <label className="flex-shrink-0 px-6 py-3 rounded-xl text-xs font-black bg-slate-100 dark:bg-slate-700 uppercase cursor-pointer">Import <input type="file" className="hidden" onChange={handleImport} /></label>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>